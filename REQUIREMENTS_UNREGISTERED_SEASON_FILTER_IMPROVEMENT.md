# 未登録シーズンフィルター改善要件

## 問題の背景

現在、未登録シーズンのみを表示する機能がありますが、以下の課題があります：

1. **現在の動作**
   - 「未登録シーズンのみ表示」フィルターを有効にすると、登録済みアニメが0件のシーズンのみが表示される
   - 検索機能を使って、未登録シーズンからアニメを一つずつ登録できる
   - アニメを登録すると、そのシーズンにアニメが追加される
   - 登録済みアニメが1件以上になったシーズンは、「未登録」ではなくなる
   - 結果として、そのシーズンがフィルターから消えてしまう

2. **ユーザーの課題**
   - 未登録シーズンから複数のアニメを順番に登録していく作業をしたい
   - しかし、一つ登録するたびにシーズンがフィルターから消えてしまい、作業が続けにくい
   - 同じ未登録シーズンに戻るためには、フィルターを一度解除してから再度適用する必要がある
   - 作業の効率が非常に悪い

## 解決策の検討

### 解決策1: セッション開始時点の未登録シーズンを基準にする（推奨）

**概要**
- 「未登録シーズンのみ表示」フィルターを有効にした時点で、未登録だったシーズンを記録
- フィルターを有効にしている間は、その時点で未登録だったシーズンを表示し続ける
- セッション中に登録したアニメは表示されるが、シーズン自体はフィルターから消えない

**メリット**
- シンプルで理解しやすい
- 実装が比較的簡単
- ユーザーの作業フローに最適

**デメリット**
- フィルターを一度解除して再度適用しないと、新しい未登録シーズンは表示されない
- （ただし、これは実際の使用では大きな問題にはならない可能性が高い）

**実装方法**
- `useYearSeasonData`フックに、`showUnregisteredOnly`が`true`になった時点での未登録シーズンリストを記録
- フィルタリング時に、記録されたシーズンリストを基準にする
- `showUnregisteredOnly`が`false`になった時に、記録をクリア

### 解決策2: ユーザーが手動でシーズンを非表示にする

**概要**
- 登録済みになったシーズンでも、ユーザーが「非表示にする」ボタンを押すまでフィルターに残す
- 各シーズンに「非表示にする」ボタンを追加

**メリット**
- ユーザーが完全にコントロールできる
- 登録作業が完了したシーズンを手動で除外できる

**デメリット**
- UIが複雑になる
- 各シーズンにボタンを追加する必要がある
- ユーザーの操作が増える

### 解決策3: オプションで「登録済みアニメをフィルターから除外しない」トグルを追加

**概要**
- 「未登録シーズンのみ表示」に加えて、「登録済みでも表示し続ける」オプションを追加
- オプションがオンの場合、登録済みになってもシーズンは表示され続ける

**メリット**
- 既存の動作は維持される
- ユーザーが選択できる

**デメリット**
- UIが複雑になる（トグルが増える）
- ユーザーが理解する必要がある

## 推奨される解決策

**解決策1: セッション開始時点の未登録シーズンを基準にする**

この解決策を推奨する理由：
1. 最もシンプルで直感的
2. ユーザーの作業フローに最も適している
3. 実装が比較的簡単
4. 追加のUI要素が不要

## 詳細な要件

### 機能要件

1. **フィルター適用時の記録**
   - 「未登録シーズンのみ表示」トグルを`false`から`true`に変更した時点で、現在未登録（登録済みアニメが0件）のシーズンリストを記録する
   - 記録形式: `Set<string>`（`"2024年春"`のようなシーズン名のセット）

2. **フィルタリングロジック**
   - `showUnregisteredOnly`が`true`の時：
     - 記録された未登録シーズンリストに含まれるシーズンのみを表示
     - セッション中に登録したアニメは表示されるが、シーズン自体はリストから削除されない
   - `showUnregisteredOnly`が`false`の時：
     - 記録をクリア
     - 通常のフィルタリングに戻る

3. **フィルター再適用時の動作**
   - フィルターを一度解除して再度適用すると、その時点での未登録シーズンを再記録
   - これにより、新しい未登録シーズンが表示されるようになる

### 非機能要件

1. **パフォーマンス**
   - 記録されたシーズンリストのサイズは通常数百件程度
   - Setによる判定は高速（O(1)）
   - パフォーマンスへの影響は最小限

2. **ユーザーエクスペリエンス**
   - 既存の動作を大きく変えない
   - 追加の操作は不要
   - 直感的で理解しやすい

## 実装方針

### 変更が必要なファイル

1. **`app/hooks/useYearSeasonData.ts`**
   - `showUnregisteredOnly`の状態管理に加えて、未登録シーズンリストを記録する状態を追加
   - `showUnregisteredOnly`が`true`になった時点で未登録シーズンを記録
   - フィルタリングロジックを変更して、記録されたシーズンリストを基準にする

### 実装の詳細

1. **状態管理**
   ```typescript
   const [unregisteredSeasonSnapshot, setUnregisteredSeasonSnapshot] = useState<Set<string> | null>(null);
   ```

2. **フィルター適用時の記録**
   - `showUnregisteredOnly`が`false`から`true`に変わった時点で、現在の未登録シーズンリストを記録
   - `useEffect`で`showUnregisteredOnly`の変化を監視

3. **フィルタリングロジックの変更**
   - `showUnregisteredOnly`が`true`の時：
     - `unregisteredSeasonSnapshot`が`null`の場合、現在の未登録シーズンを記録
     - `unregisteredSeasonSnapshot`に含まれるシーズンのみを表示

## 今後の検討事項

- フィルターを有効にしている間、新しい未登録シーズン（他のページから登録されたなど）が自動的に表示されるかどうか
  - 現在の推奨実装では、フィルターを一度解除して再度適用する必要がある
  - 将来的に、リアルタイムで更新する機能を追加することも検討可能

## 参考

- 現在の実装: `app/hooks/useYearSeasonData.ts` の104-106行目
- 関連コンポーネント: `app/components/tabs/HomeTab.tsx` の242-255行目

